from mindee import Client, product
from time import sleep
from mindee.parsing.common import AsyncPredictResponse

from mindee.product import InvoiceSplitterV1

# Init a new client
mindee_client = Client(api_key="my-api-key")

# Load a file from disk
input_doc = mindee_client.source_from_path("/path/to/the/file.ext")


# Load a file from disk and enqueue it.
queue_result: AsyncPredictResponse = mindee_client.enqueue(InvoiceSplitterV1, input_doc)

# Get the id of the queue (job)
queue_id = queue_result.job.id


# Limit the amount of API calls to retrieve your document
MAX_RETRIES = 10

# How many seconds to wait in-between tries
INTERVAL_SECS = 6
# Recursive function that tries to retrieve the completed document.
# If the document is not "complete", try again
def get_doc_from_async_queue(queue_id, times_tried=0)->None:

    # Have we exceeded our retry count?
    if times_tried >= MAX_RETRIES:
        raise Exception(f"Maximum retries reached {times_tried}")
    
    # Wait for a few seconds before fetching
    sleep(INTERVAL_SECS)

    # Fetch and parse the result, using the same type
    parsed_result = mindee_client.parse_queued(InvoiceSplitterV1, queue_id)

    # Check whether the result is ready
    if parsed_result.job.status == "completed":

        # Print a brief summary of the parsed data
        print(parsed_result.document)
        return

    # Otherwise, try again...
    else:
        get_doc_from_async_queue(queue_id, times_tried+1)

# Start the recursion...
get_doc_from_async_queue(queue_id)
